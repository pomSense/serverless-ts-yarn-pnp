{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ApolloServerPluginInlineTraceDisabled = exports.ApolloServerPluginInlineTrace = void 0;\nconst apollo_reporting_protobuf_1 = require(\"apollo-reporting-protobuf\");\nconst traceTreeBuilder_1 = require(\"../traceTreeBuilder\");\nconst schemaIsFederated_1 = require(\"../schemaIsFederated\");\nfunction ApolloServerPluginInlineTrace(options = Object.create(null)) {\n  let enabled = options.__onlyIfSchemaIsFederated ? null : true;\n  return {\n    __internal_plugin_id__() {\n      return 'InlineTrace';\n    },\n    async serverWillStart({\n      schema,\n      logger\n    }) {\n      if (enabled === null) {\n        enabled = (0, schemaIsFederated_1.schemaIsFederated)(schema);\n        if (enabled) {\n          logger.info('Enabling inline tracing for this federated service. To disable, use ' + 'ApolloServerPluginInlineTraceDisabled.');\n        }\n      }\n    },\n    async requestDidStart({\n      request: {\n        http\n      },\n      metrics\n    }) {\n      if (!enabled) {\n        return;\n      }\n      const treeBuilder = new traceTreeBuilder_1.TraceTreeBuilder({\n        rewriteError: options.rewriteError\n      });\n      if ((http === null || http === void 0 ? void 0 : http.headers.get('apollo-federation-include-trace')) !== 'ftv1') {\n        return;\n      }\n      if (metrics.captureTraces === false) {\n        return;\n      }\n      metrics.captureTraces = true;\n      treeBuilder.startTiming();\n      return {\n        async executionDidStart() {\n          return {\n            willResolveField({\n              info\n            }) {\n              return treeBuilder.willResolveField(info);\n            }\n          };\n        },\n        async didEncounterErrors({\n          errors\n        }) {\n          treeBuilder.didEncounterErrors(errors);\n        },\n        async willSendResponse({\n          response\n        }) {\n          treeBuilder.stopTiming();\n          if (metrics.queryPlanTrace) {\n            treeBuilder.trace.queryPlan = metrics.queryPlanTrace;\n          }\n          const encodedUint8Array = apollo_reporting_protobuf_1.Trace.encode(treeBuilder.trace).finish();\n          const encodedBuffer = Buffer.from(encodedUint8Array, encodedUint8Array.byteOffset, encodedUint8Array.byteLength);\n          const extensions = response.extensions || (response.extensions = Object.create(null));\n          if (typeof extensions.ftv1 !== 'undefined') {\n            throw new Error('The `ftv1` extension was already present.');\n          }\n          extensions.ftv1 = encodedBuffer.toString('base64');\n        }\n      };\n    }\n  };\n}\nexports.ApolloServerPluginInlineTrace = ApolloServerPluginInlineTrace;\nfunction ApolloServerPluginInlineTraceDisabled() {\n  return {\n    __internal_plugin_id__() {\n      return 'InlineTrace';\n    }\n  };\n}\nexports.ApolloServerPluginInlineTraceDisabled = ApolloServerPluginInlineTraceDisabled;","map":{"version":3,"mappings":";;;;;;AAAA,MAAAA,2BAAA,GAAAC,OAAA;AACA,MAAAC,kBAAA,GAAAD,OAAA;AAGA,MAAAE,mBAAA,GAAAF,OAAA;AA4BA,SAAgBG,6BAA6BA,CAC3CC,OAAA,GAAgDC,MAAM,CAACC,MAAM,CAAC,IAAI,CAAC;EAEnE,IAAIC,OAAO,GAAmBH,OAAO,CAACI,yBAAyB,GAAG,IAAI,GAAG,IAAI;EAC7E,OAAO;IACLC,sBAAsBA,CAAA;MACpB,OAAO,aAAa;IACtB,CAAC;IACD,MAAMC,eAAeA,CAAC;MAAEC,MAAM;MAAEC;IAAM,CAAE;MAKtC,IAAIL,OAAO,KAAK,IAAI,EAAE;QACpBA,OAAO,GAAG,IAAAL,mBAAA,CAAAW,iBAAiB,EAACF,MAAM,CAAC;QACnC,IAAIJ,OAAO,EAAE;UACXK,MAAM,CAACE,IAAI,CACT,sEAAsE,GACpE,wCAAwC,CAC3C;;;IAGP,CAAC;IACD,MAAMC,eAAeA,CAAC;MAAEC,OAAO,EAAE;QAAEC;MAAI,CAAE;MAAEC;IAAO,CAAE;MAClD,IAAI,CAACX,OAAO,EAAE;QACZ;;MAGF,MAAMY,WAAW,GAAG,IAAIlB,kBAAA,CAAAmB,gBAAgB,CAAC;QACvCC,YAAY,EAAEjB,OAAO,CAACiB;OACvB,CAAC;MAGF,IAAI,CAAAJ,IAAI,aAAJA,IAAI,uBAAJA,IAAI,CAAEK,OAAO,CAACC,GAAG,CAAC,iCAAiC,CAAC,MAAK,MAAM,EAAE;QACnE;;MAKF,IAAIL,OAAO,CAACM,aAAa,KAAK,KAAK,EAAE;QACnC;;MAMFN,OAAO,CAACM,aAAa,GAAG,IAAI;MAE5BL,WAAW,CAACM,WAAW,EAAE;MAEzB,OAAO;QACL,MAAMC,iBAAiBA,CAAA;UACrB,OAAO;YACLC,gBAAgBA,CAAC;cAAEb;YAAI,CAAE;cACvB,OAAOK,WAAW,CAACQ,gBAAgB,CAACb,IAAI,CAAC;YAC3C;WACD;QACH,CAAC;QAED,MAAMc,kBAAkBA,CAAC;UAAEC;QAAM,CAAE;UACjCV,WAAW,CAACS,kBAAkB,CAACC,MAAM,CAAC;QACxC,CAAC;QAED,MAAMC,gBAAgBA,CAAC;UAAEC;QAAQ,CAAE;UAGjCZ,WAAW,CAACa,UAAU,EAAE;UAMxB,IAAId,OAAO,CAACe,cAAc,EAAE;YAC1Bd,WAAW,CAACe,KAAK,CAACC,SAAS,GAAGjB,OAAO,CAACe,cAAc;;UAGtD,MAAMG,iBAAiB,GAAGrC,2BAAA,CAAAsC,KAAK,CAACC,MAAM,CAACnB,WAAW,CAACe,KAAK,CAAC,CAACK,MAAM,EAAE;UAClE,MAAMC,aAAa,GAAGC,MAAM,CAACC,IAAI,CAC/BN,iBAAiB,EACjBA,iBAAiB,CAACO,UAAU,EAC5BP,iBAAiB,CAACQ,UAAU,CAC7B;UAED,MAAMC,UAAU,GACdd,QAAQ,CAACc,UAAU,KAAKd,QAAQ,CAACc,UAAU,GAAGxC,MAAM,CAACC,MAAM,CAAC,IAAI,CAAC,CAAC;UAIpE,IAAI,OAAOuC,UAAU,CAACC,IAAI,KAAK,WAAW,EAAE;YAC1C,MAAM,IAAIC,KAAK,CAAC,2CAA2C,CAAC;;UAG9DF,UAAU,CAACC,IAAI,GAAGN,aAAa,CAACQ,QAAQ,CAAC,QAAQ,CAAC;QACpD;OACD;IACH;GACD;AACH;AAjGAC,OAAA,CAAA9C,6BAAA,GAAAA,6BAAA;AAqGA,SAAgB+C,qCAAqCA,CAAA;EACnD,OAAO;IACLzC,sBAAsBA,CAAA;MACpB,OAAO,aAAa;IACtB;GACD;AACH;AANAwC,OAAA,CAAAC,qCAAA,GAAAA,qCAAA","names":["apollo_reporting_protobuf_1","require","traceTreeBuilder_1","schemaIsFederated_1","ApolloServerPluginInlineTrace","options","Object","create","enabled","__onlyIfSchemaIsFederated","__internal_plugin_id__","serverWillStart","schema","logger","schemaIsFederated","info","requestDidStart","request","http","metrics","treeBuilder","TraceTreeBuilder","rewriteError","headers","get","captureTraces","startTiming","executionDidStart","willResolveField","didEncounterErrors","errors","willSendResponse","response","stopTiming","queryPlanTrace","trace","queryPlan","encodedUint8Array","Trace","encode","finish","encodedBuffer","Buffer","from","byteOffset","byteLength","extensions","ftv1","Error","toString","exports","ApolloServerPluginInlineTraceDisabled"],"sourceRoot":"","sources":["../../../src/plugin/inlineTrace/index.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}